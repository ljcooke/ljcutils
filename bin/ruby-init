#!/bin/sh
# ruby-init: Set up a Ruby project to be managed with rbenv and Bundler.
#
# Source: https://github.com/ljcooke/ljcutils
# License: MIT
# Copyright: (c) 2019 Liam Cooke

set -o errexit
set -o nounset

usage() {
  cmd=$(basename "$0")
  echo "Usage: $cmd [OPTIONS...] RUBY_VERSION"
  echo
  echo "Options:"
  echo "  -d DIR      create files in directory DIR"
  echo "  -h          show this help message"
  echo
  echo "Example: $cmd -d my-project 2.6.3"
}

dest_dir='.'

while getopts ':d:h' opt; do
  case "$opt" in
    d)
      dest_dir="$OPTARG"
      ;;
    h)
      usage
      exit
      ;;
    \?)
      1>&2 echo "Unknown option: -$OPTARG"
      1>&2 echo
      1>&2 usage
      exit 1
      ;;
    :)
      1>&2 echo "Error: Option -$OPTARG is missing an argument"
      1>&2 echo
      1>&2 usage
      ;;
  esac
done
shift $((OPTIND -1))

ruby_version=${1:-}

if [ -z "$ruby_version" ]; then
  1>&2 usage
  exit 1
fi

if [ -e "${dest_dir}/Gemfile" ]; then
  1>&2 echo "Error: File exists: Gemfile"
  exit 1
fi

if [ "$dest_dir" != '.' ]; then
  mkdir -p "$dest_dir"
  cd "$dest_dir"
fi

rbenv install --skip-existing "$ruby_version"
rbenv local "$ruby_version"

gem install bundler

cat <<'RUBY' > Gemfile
# frozen_string_literal: true

source 'https://rubygems.org'
RUBY

bundle install
